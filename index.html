<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Shotclock</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a2a;
      --accent:#ffcc00;
      --danger:#ff3b30;
      --text:#e7eefc;
      --muted:#93a4c7;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    body{
      margin:0;
      background:linear-gradient(180deg,#060a12, #0b0f17 40%, #060a12);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      touch-action: manipulation;
    }

    .app{
      width:min(1100px, 100%);
      background:rgba(18,26,42,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    #err{
      display:none;
      padding:10px 12px;
      background:rgba(255,59,48,.18);
      border-bottom:1px solid rgba(255,59,48,.35);
      color:#ffd1ce;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
    }

    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; background:rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    header h1{font-size:14px;margin:0;letter-spacing:.8px;color:var(--muted);font-weight:900;}
    header .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .kbd{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px;
      background:rgba(0,0,0,.18); user-select:none;
    }
    button.ghost{
      background:transparent; border:1px solid rgba(255,255,255,.12);
      color:var(--text); padding:10px 12px; border-radius:12px; font-weight:900; cursor:pointer;
    }

    main{
      padding:16px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* TOP: CLOCK */
    .displayWrap{
      background:radial-gradient(1200px 520px at 50% 30%, rgba(255,204,0,.16), transparent 55%),
                 rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px 14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height: 240px;
    }

    .time{
      font-variant-numeric:tabular-nums;
      font-size: clamp(110px, 16vw, 230px);
      line-height:1;
      font-weight:900;
      letter-spacing:2px;
      color:var(--accent);
      text-shadow:0 10px 40px rgba(255,204,0,.18);
      user-select:none;
      min-height: 1em;
    }
    .time.danger{ color:var(--danger); text-shadow:0 10px 40px rgba(255,59,48,.18); }

    .sub{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:center;
      user-select:none;
    }

    /* MIDDLE: MAIN BUTTONS */
    .mainButtons{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
      align-items:stretch;
    }

    /* In landscape on tablets, keep 3 columns; on narrow portrait, use 2 columns */
    @media (max-width: 760px){
      .mainButtons{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    button{
      appearance:none; border:0; cursor:pointer;
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      transition:transform .05s ease, background .12s ease;
    }
    button:active{ transform:scale(.98); }

    button.primary{ background:rgba(255,204,0,.18); border-color:rgba(255,204,0,.35); color:#fff1b3;}
    button.danger{ background:rgba(255,59,48,.16); border-color:rgba(255,59,48,.35); color:#ffd1ce;}

    /* 3x Größe (nur diese 5 Buttons) */
    .mainBtn{
      min-height: 88px;
      padding: 22px 26px;
      font-size: 34px;
      line-height: 1;
      border-radius: 20px;
      width:100%;
    }

    /* BOTTOM: SETTINGS */
    .card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .smallBtn{
      min-width:auto;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
    }
    input[type="number"]{
      width:160px;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-weight:900;
      outline:none;
    }
    label{color:var(--muted); font-size:12px; display:flex; flex-direction:column; gap:6px;}
    .hint{color:var(--muted); font-size:12px; line-height:1.4; margin:12px 0 0;}

    .footer{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <div id="err"></div>

    <header>
      <h1>SHOTCLOCK</h1>
      <div class="right">
        <span class="kbd">Space: Start/Stop</span>
        <span class="kbd">R: Blank</span>
        <button class="ghost" id="btnFullscreen">Vollbild</button>
      </div>
    </header>

    <main>
      <!-- TOP: CLOCK -->
      <div class="displayWrap">
        <div class="time" id="time">24.0</div>
        <div class="sub">
          <span>Status: <strong id="status">Bereit</strong></span>
          <span>Modus: <strong id="modeLabel">24</strong>s</span>
          <span>Sound: <strong id="soundLabel">AN</strong></span>
          <span>Screen: <strong id="wakeLabel">AUS</strong></span>
        </div>
      </div>

      <!-- MIDDLE: 5 MAIN BUTTONS -->
      <div class="mainButtons">
        <button id="btnStart" class="primary mainBtn">Start</button>
        <button id="btnStop" class="mainBtn">Stop</button>
        <button id="btnBlank" class="danger mainBtn">Blank</button>
        <button id="btn24" class="mainBtn">24</button>
        <button id="btn14" class="mainBtn">14</button>
      </div>

      <!-- BOTTOM: SETTINGS (can be lower; still visible on tablets) -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <label>
            Warnung ab (s)
            <input id="warnAt" type="number" min="0" step="0.5" value="5" />
          </label>

          <label>
            Sekunden setzen
            <input id="setSeconds" type="number" min="0" step="0.1" value="24" />
          </label>

          <button id="btnSet" class="smallBtn">Set</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnSound" class="smallBtn">Sound AN/AUS</button>
          <button id="btnWake" class="smallBtn">Bildschirm an</button>
          <button id="btnPlus" class="smallBtn">+0.1</button>
          <button id="btnMinus" class="smallBtn">−0.1</button>
        </div>

        <p class="hint">
          Installieren: Chrome → Menü (⋮) → <b>„App installieren“</b> / <b>„Zum Startbildschirm hinzufügen“</b>.<br>
          Hinweis: Ton & „Bildschirm an“ funktionieren oft erst nach dem ersten Tippen.
        </p>
      </div>
    </main>

    <div class="footer">
      <span>Nur Shotclock • 24/14 • Start/Stop • Blank</span>
      <span>PWA offline-fähig</span>
    </div>
  </div>

<script>
(() => {
  // On-screen error reporting
  const errEl = document.getElementById("err");
  const showErr = (msg) => { errEl.style.display = "block"; errEl.textContent = msg; };
  window.addEventListener("error", (e) => showErr("JS-Fehler:\n" + (e?.message || e)));
  window.addEventListener("unhandledrejection", (e) =>
    showErr("Promise-Fehler:\n" + (e?.reason?.message || e?.reason || e))
  );

  // Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try{
        const reg = await navigator.serviceWorker.register("./sw.js");
        if (reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });
      } catch(e){
        showErr("Service Worker konnte nicht registriert werden:\n" + (e?.message || e));
      }
    });
  }

  // Elements
  const elTime = document.getElementById('time');
  const elStatus = document.getElementById('status');
  const elMode = document.getElementById('modeLabel');
  const elSoundLabel = document.getElementById('soundLabel');
  const elWakeLabel = document.getElementById('wakeLabel');

  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnBlank = document.getElementById('btnBlank');
  const btn24    = document.getElementById('btn24');
  const btn14    = document.getElementById('btn14');
  const btnSet   = document.getElementById('btnSet');

  const btnSound = document.getElementById('btnSound');
  const btnWake  = document.getElementById('btnWake');
  const btnPlus  = document.getElementById('btnPlus');
  const btnMinus = document.getElementById('btnMinus');
  const btnFullscreen = document.getElementById('btnFullscreen');

  const inpSet  = document.getElementById('setSeconds');
  const inpWarn = document.getElementById('warnAt');

  // State
  let defaultMode = 24;
  let remaining = defaultMode;
  let running = false;
  let isBlank = false;

  let lastTs = null;
  let rafId = null;

  // Sound
  let soundOn = true;
  let audioCtx = null;

  // Wake Lock
  let wakeLock = null;
  let wakeOn = false;

  function formatTime(sec){
    const s = Math.max(0, sec);
    return (Math.round(s * 10) / 10).toFixed(1);
  }
  function setStatus(txt){ elStatus.textContent = txt; }

  function render(){
    if (isBlank){
      elTime.textContent = "";
      elTime.classList.remove('danger');
    } else {
      elTime.textContent = formatTime(remaining);
      const warnAt = Number(inpWarn.value || 0);
      elTime.classList.toggle('danger', remaining <= warnAt && running);
    }
    elSoundLabel.textContent = soundOn ? "AN" : "AUS";
    elWakeLabel.textContent = wakeOn ? "AN" : "AUS";
  }

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }

  // Horn: klassisch/clean
  function beep(){
    if (!soundOn) return;
    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;

      const master = ctx.createGain();
      master.gain.setValueAtTime(0.0001, now);
      master.connect(ctx.destination);

      const dur = 0.75;
      master.gain.exponentialRampToValueAtTime(0.55, now + 0.015);
      master.gain.setValueAtTime(0.55, now + dur - 0.10);
      master.gain.exponentialRampToValueAtTime(0.0001, now + dur);

      const o1 = ctx.createOscillator();
      const o2 = ctx.createOscillator();
      o1.type = "triangle";
      o2.type = "sine";

      o1.detune.setValueAtTime(-4, now);
      o2.detune.setValueAtTime(+4, now);

      o1.frequency.setValueAtTime(740, now);
      o2.frequency.setValueAtTime(740, now);
      o1.frequency.exponentialRampToValueAtTime(640, now + dur);
      o2.frequency.exponentialRampToValueAtTime(640, now + dur);

      const bp = ctx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(900, now);
      bp.Q.setValueAtTime(0.8, now);

      const g1 = ctx.createGain();
      const g2 = ctx.createGain();
      g1.gain.setValueAtTime(0.8, now);
      g2.gain.setValueAtTime(0.5, now);

      const lfo = ctx.createOscillator();
      const lfoGain = ctx.createGain();
      lfo.type = "sine";
      lfo.frequency.setValueAtTime(6.0, now);
      lfoGain.gain.setValueAtTime(6, now);
      lfo.connect(lfoGain);
      lfoGain.connect(o1.frequency);
      lfoGain.connect(o2.frequency);

      o1.connect(g1).connect(bp);
      o2.connect(g2).connect(bp);
      bp.connect(master);

      lfo.start(now);
      o1.start(now);
      o2.start(now);

      const stopAt = now + dur + 0.05;
      lfo.stop(stopAt);
      o1.stop(stopAt);
      o2.stop(stopAt);
    } catch(e){}
  }

  async function enableWakeLock(){
    try{
      if (!("wakeLock" in navigator)) return false;
      wakeLock = await navigator.wakeLock.request("screen");
      wakeOn = true;
      wakeLock.addEventListener("release", () => { wakeOn = false; render(); });
      return true;
    } catch(e){
      wakeOn = false;
      return false;
    } finally { render(); }
  }

  async function disableWakeLock(){
    try{ await wakeLock?.release(); } catch(e){}
    wakeLock = null;
    wakeOn = false;
    render();
  }

  document.addEventListener("visibilitychange", async () => {
    if (wakeOn && document.visibilityState === "visible") await enableWakeLock();
  });

  function stopLoopOnly(){
    running = false;
    lastTs = null;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function stop(){
    stopLoopOnly();
    setStatus(isBlank ? "Blank" : "Pausiert");
    render();
  }

  function tick(ts){
    if (!running) return;

    if (lastTs == null) lastTs = ts;
    const dt = (ts - lastTs) / 1000;
    lastTs = ts;

    remaining -= dt;

    if (remaining <= 0){
      remaining = 0;
      render();
      setStatus("0.0");
      stopLoopOnly();
      beep();
      setStatus("Pausiert");
      return;
    }

    render();
    rafId = requestAnimationFrame(tick);
  }

  function start(){
    if (running) return;

    if (isBlank){
      isBlank = false;
      remaining = defaultMode;
    }
    if (remaining <= 0) remaining = defaultMode;

    running = true;
    setStatus("Läuft");
    render();
    rafId = requestAnimationFrame(tick);
  }

  function blank(){
    stopLoopOnly();
    isBlank = true;
    setStatus("Blank");
    render();
  }

  // 24/14: weiterlaufen, wenn vorher laufend
  function setModeAndMaybeResume(sec){
    const wasRunning = running;
    stopLoopOnly();

    isBlank = false;
    defaultMode = sec;
    remaining = sec;

    elMode.textContent = String(sec);
    inpSet.value = sec;

    if (wasRunning) start();
    else { setStatus("Bereit"); render(); }
  }

  function setTo(sec){
    stopLoopOnly();
    isBlank = false;
    remaining = Math.max(0, sec);
    setStatus("Bereit");
    render();
  }

  // Buttons
  btnStart.addEventListener('click', () => { ensureAudio(); start(); });
  btnStop.addEventListener('click', () => stop());
  btnBlank.addEventListener('click', () => blank());

  btn24.addEventListener('click', () => setModeAndMaybeResume(24));
  btn14.addEventListener('click', () => setModeAndMaybeResume(14));

  btnSet.addEventListener('click', () => setTo(Number(inpSet.value || 0)));

  btnPlus.addEventListener('click', () => { isBlank=false; remaining = Math.min(99.9, remaining + 0.1); render(); });
  btnMinus.addEventListener('click', () => { isBlank=false; remaining = Math.max(0, remaining - 0.1); render(); });

  btnSound.addEventListener('click', () => { soundOn = !soundOn; render(); });

  btnWake.addEventListener('click', async () => { if (!wakeOn) await enableWakeLock(); else await disableWakeLock(); });

  btnFullscreen.addEventListener('click', async () => {
    const app = document.getElementById('app');
    try{
      if (!document.fullscreenElement) await app.requestFullscreen();
      else await document.exitFullscreen();
    } catch(e){}
  });

  // Keyboard
  window.addEventListener('keydown', (e) => {
    if (e.repeat) return;
    const k = e.key.toLowerCase();
    if (k === " "){ e.preventDefault(); ensureAudio(); running ? stop() : start(); }
    if (k === "r") blank();
    if (k === "1") setModeAndMaybeResume(24);
    if (k === "2") setModeAndMaybeResume(14);
  });

  render();
})();
</script>
</body>
</html>
